#!/usr/bin/env bash

cd $(dirname $(readlink -f $0))

./expand-result-archives

FHIR_DIR=../fhir
TRASH_CAN=saved-$(date +%s)
[ ! -d $TRASH_CAN ] && mkdir $TRASH_CAN


for resultsDir in $(find . -maxdepth 1 -type d -name "lab-crawl-*")
do
  echo "Processing $resultsDir"
  NAME=$(basename $resultsDir)
  TARGET=$FHIR_DIR/$NAME
  [ ! -d $TARGET ] && mkdir -p $TARGET
  mv $resultsDir/patient-id $resultsDir/icn $TARGET
  for TXT in $(find $resultsDir -name "*txt" -exec grep -l "OUTCOME: " {} \;)
  do
   JSON=${TXT/.txt/.json}
   mv -v $TXT $JSON $TARGET
  done
  rm $TARGET/summary.csv $TARGET/crawler.log 2> /dev/null
  mv $resultsDir $TRASH_CAN
done
